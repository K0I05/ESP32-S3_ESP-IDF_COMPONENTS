# Technical Documentation: ESP-IDF Driver for Sensirion SHT4X Series of Sensors

[![K0I05](https://img.shields.io/badge/K0I05-a9a9a9?logo=data:image/svg%2bxml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODgiIGhlaWdodD0iMTg3Ij48cGF0aCBmaWxsPSIjNDU0QjU0IiBkPSJNMTU1LjU1NSAyMS45M2MxOS4yNzMgMTUuOTggMjkuNDcyIDM5LjM0NSAzMi4xNjggNjMuNzg5IDEuOTM3IDIyLjkxOC00LjU1MyA0Ni42Ni0xOC44NDggNjQuNzgxQTUwOS40NzggNTA5LjQ3OCAwIDAgMSAxNjUgMTU1bC0xLjQ4NCAxLjg4M2MtMTMuMTk2IDE2LjUzMS0zNS41NTUgMjcuMjE1LTU2LjMzOSAyOS45MDItMjguMzEyIDIuOC01Mi4yNTUtNC43MzctNzQuNzMyLTIxLjcxNUMxMy4xNzIgMTQ5LjA5IDIuOTczIDEyNS43MjUuMjc3IDEwMS4yODEtMS42NiA3OC4zNjMgNC44MyA1NC42MjEgMTkuMTI1IDM2LjVBNTA5LjQ3OCA1MDkuNDc4IDAgMCAxIDIzIDMybDEuNDg0LTEuODgzQzM3LjY4IDEzLjU4NiA2MC4wNCAyLjkwMiA4MC44MjMuMjE1YzI4LjMxMi0yLjggNTIuMjU1IDQuNzM3IDc0LjczMiAyMS43MTVaIi8+PHBhdGggZmlsbD0iI0ZERkRGRCIgZD0iTTExOS44NjcgNDUuMjdDMTI4LjkzMiA1Mi4yNiAxMzMuODIgNjMgMTM2IDc0Yy42MyA0Ljk3Mi44NDIgOS45NTMuOTUzIDE0Ljk2LjA0NCAxLjkxMS4xMjIgMy44MjIuMjAzIDUuNzMxLjM0IDEyLjIxLjM0IDEyLjIxLTMuMTU2IDE3LjMwOWE5NS42MDQgOTUuNjA0IDAgMCAxLTQuMTg4IDMuNjI1Yy00LjUgMy43MTctNi45NzQgNy42ODgtOS43MTcgMTIuODAzQzEwNi45NCAxNTIuNzkyIDEwNi45NCAxNTIuNzkyIDk3IDE1N2MtMy40MjMuNTkyLTUuODAxLjY4NS04Ljg3OS0xLjA3NC05LjgyNi03Ljg4LTE2LjAzNi0xOS41OS0yMS44NTgtMzAuNTEyLTIuNTM0LTQuNTc1LTUuMDA2LTcuMjEtOS40NjYtMTAuMDItMy43MTQtMi44ODItNS40NS02Ljk4Ni02Ljc5Ny0xMS4zOTQtLjU1LTQuODg5LS41NjEtOS4zMTYgMS0xNCAuMDkzLTEuNzYzLjE4Mi0zLjUyNy4yMzktNS4yOTIuNDkxLTEzLjg4NCAzLjg2Ni0yNy4wNTcgMTQuMTU2LTM3LjAyOCAxNy4yMTgtMTQuMzM2IDM1Ljg1OC0xNS4wNjYgNTQuNDcyLTIuNDFaIi8+PHBhdGggZmlsbD0iI0M2RDVFMCIgZD0iTTEwOSAzOWMxMS43MDMgNS4yNTUgMTkuMjA2IDEzLjE4NiAyNC4yOTMgMjUuMDA0IDIuODU3IDguMjQgMy40NyAxNi4zMTYgMy42NiAyNC45NTYuMDQ0IDEuOTExLjEyMiAzLjgyMi4yMDMgNS43MzEuMzQgMTIuMjEuMzQgMTIuMjEtMy4xNTYgMTcuMzA5YTk1LjYwNCA5NS42MDQgMCAwIDEtNC4xODggMy42MjVjLTQuNSAzLjcxNy02Ljk3NCA3LjY4OC05LjcxNyAxMi44MDNDMTA2LjgwNCAxNTMuMDQxIDEwNi44MDQgMTUzLjA0MSA5NyAxNTdjLTIuMzMyLjA3OC00LjY2OC4wOS03IDBsMi4xMjUtMS44NzVjNS40My01LjQ0NSA4Ljc0NC0xMi41NzcgMTEuNzU0LTE5LjU1OWEzNDkuNzc1IDM0OS43NzUgMCAwIDEgNC40OTYtOS44NzlsMS42NDgtMy41NWMyLjI0LTMuNTU1IDQuNDEtNC45OTYgNy45NzctNy4xMzcgMi4zMjMtMi42MSAyLjMyMy0yLjYxIDQtNWwtMyAxYy0yLjY4LjE0OC01LjMxOS4yMy04IC4yNWwtMi4xOTUuMDYzYy01LjI4Ny4wMzktNS4yODcuMDM5LTcuNzc4LTEuNjUzLTEuNjY2LTIuNjkyLTEuNDUzLTQuNTYtMS4wMjctNy42NiAyLjM5NS00LjM2MiA0LjkyNC04LjA0IDkuODI4LTkuNTcgMi4zNjQtLjQ2OCA0LjUxNC0uNTI4IDYuOTIyLS40OTNsMi40MjIuMDI4TDEyMSA5MmwtMS0yYTkyLjc1OCA5Mi43NTggMCAwIDEtLjM2LTQuNTg2QzExOC42IDY5LjYzMiAxMTYuNTE3IDU2LjA5NCAxMDQgNDVjLTUuOTA0LTQuNjY0LTExLjYtNi4wODgtMTktNyA3LjU5NC00LjI2NCAxNi4yMjMtMS44MSAyNCAxWiIvPjxwYXRoIGZpbGw9IiM0OTUwNTgiIGQ9Ik03NyA5MmM0LjYxMyAxLjY3MSA3LjI2IDMuOTQ1IDEwLjA2MyA3LjkzOCAxLjA3OCAzLjUyMy45NzYgNS41NDYtLjA2MyA5LjA2Mi0yLjk4NCAyLjk4NC02LjI1NiAyLjM2OC0xMC4yNSAyLjM3NWwtMi4yNzcuMDc0Yy01LjI5OC4wMjgtOC4yNTQtLjk4My0xMi40NzMtNC40NDktMi44MjYtMy41OTctMi40MTYtNy42MzQtMi0xMiA0LjUwMi00LjcyOCAxMC45OS0zLjc2IDE3LTNaIi8+PHBhdGggZmlsbD0iIzQ4NEY1NyIgZD0ibTExOCA5MS43NSAzLjEyNS0uMDc4YzMuMjU0LjM3MSA0LjU5NyAxLjAwMiA2Ljg3NSAzLjMyOC42MzkgNC4yMzEuMjkgNi40NDItMS42ODggMTAuMjUtMy40MjggNC4wNzgtNS44MjcgNS41OTgtMTEuMTk1IDYuMTQ4LTEuNDE0LjAwOC0yLjgyOCAwLTQuMjQyLS4wMjNsLTIuMTY4LjAzNWMtMi45OTgtLjAxNy01LjE1Ny0uMDMzLTcuNjcyLTEuNzU4LTEuNjgxLTIuNjg0LTEuNDYtNC41NTItMS4wMzUtNy42NTIgMi4zNzUtNC4zMjUgNC44OTQtOC4wMDkgOS43NS05LjU1OSAyLjc3Ny0uNTQ0IDUuNDItLjY0OSA4LjI1LS42OTFaIi8+PHBhdGggZmlsbD0iIzUyNTg2MCIgZD0iTTg2IDEzNGgxNmwxIDRjLTIgMi0yIDItNS4xODggMi4yNjZMOTQgMTQwLjI1bC0zLjgxMy4wMTZDODcgMTQwIDg3IDE0MCA4NSAxMzhsMS00WiIvPjwvc3ZnPg==)](https://github.com/K0I05)
[![License: MIT](https://cdn.prod.website-files.com/5e0f1144930a8bc8aace526c/65dd9eb5aaca434fac4f1c34_License-MIT-blue.svg)](/LICENSE)
[![Language](https://img.shields.io/badge/Language-C-navy.svg)](https://en.wikipedia.org/wiki/C_(programming_language))
[![Framework](https://img.shields.io/badge/Framework-ESP_IDF-red?logo=espressif)](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/index.html)
[![Edited with VS Code](https://img.shields.io/badge/Edited_with-VS_Code-007ACC?logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImEiIHgxPSI1MCIgeTE9IjAiIHgyPSI1MCIgeTI9IjEwMCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPjxzdG9wIHN0b3AtY29sb3I9IiNmZmYiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNmZmYiIHN0b3Atb3BhY2l0eT0iMCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxwYXRoIGZpbGw9IiMwMDY1QTkiIGQ9Ik05Ni40NiAxMC44IDc1Ljg2Ljg4QzczLjQ3LS4yNyA3MC42Mi4yMSA2OC43NSAyLjA4TDEuMyA2My41OGMtMS44MiAxLjY1LTEuODIgNC41MSAwIDYuMTZsNS41MSA1LjAxYzEuNDkgMS4zNSAzLjcyIDEuNDUgNS4zMi4yNGw4MS4yMy02MS42MmMyLjcyLTIuMDcgNi42NC0uMTMgNi42NCAzLjI5di0uMjRjMC0yLjQtMS4zOC00LjU5LTMuNTQtNS42M1oiLz48cGF0aCBmaWxsPSIjMDA3QUNDIiBkPSJNOTYuNDYgODkuMiA3NS44NiA5OS4xMmMtMi4zOSAxLjE1LTUuMjQuNjYtNy4xMS0xLjJMMS4zIDM2LjQyYy0xLjgyLTEuNjUtMS44Mi00LjUxIDAtNi4xN2w1LjUxLTUuMDFjMS40OS0xLjM1IDMuNzItMS40NSA1LjMyLS4yM2w4MS4yMyA2MS42MmMyLjcyIDIuMDcgNi42NC4xMyA2LjY0LTMuM3YuMjRjMCAyLjQtMS4zOCA0LjU5LTMuNTQgNS42M1oiLz48cGF0aCBmaWxsPSIjMUY5Q0YwIiBkPSJNNzUuODYgOTkuMTNjLTIuMzkgMS4xNS01LjI0LjY2LTcuMTEtMS4yMSAyLjMxIDIuMzEgNi4yNS42NiA2LjI1LTIuNlY0LjY3YzAtMy4yNi0zLjk0LTQuODktNi4yNS0yLjU4IDEuODctMS44NyA0LjcyLTIuMzYgNy4xMS0xLjIxbDIwLjYgOS45MWMyLjE2IDEuMDQgMy41NCAzLjIzIDMuNTQgNS42M3Y2Ny4xN2MwIDIuNC0xLjM4IDQuNTktMy41NCA1LjYzbC0yMC42IDkuOTFaIi8+PHBhdGggZmlsbD0idXJsKCNhKSIgZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNNzAuODUgOTkuMzJjMS41OC42MSAzLjM3LjU3IDQuOTYtLjE5bDIwLjU5LTkuOTFjMi4xNi0xLjA0IDMuNTQtMy4yMyAzLjU0LTUuNjNWMTYuNDFjMC0yLjQtMS4zOC00LjU5LTMuNTQtNS42M0w3NS44MS44N2MtMi4wOS0xLTQuNTMtLjc2LTYuMzYuNTgtLjI2LjE5LS41MS40LS43NC42NEwyOS4yOSAzOC4wNGwtMTcuMTctMTMuMDNjLTEuNi0xLjIxLTMuODMtMS4xMS01LjMyLjI0bC01LjUgNS4wMWMtMS44MiAxLjY1LTEuODIgNC41MSAwIDYuMTZMMTYuMTkgNTAgMS4zIDYzLjU4Yy0xLjgyIDEuNjUtMS44MiA0LjUxIDAgNi4xN2w1LjUxIDUuMDFjMS40OSAxLjM1IDMuNzIgMS40NSA1LjMyLjIzbDE3LjE3LTEzLjAzIDM5LjQxIDM1Ljk2Yy42Mi42MiAxLjM2IDEuMDkgMi4xNCAxLjRaTTc0Ljk1IDI3LjMgNDUuMDUgNTBsMjkuOSAyMi43VjI3LjNaIiBvcGFjaXR5PSIuMjUiIHN0eWxlPSJtaXgtYmxlbmQtbW9kZTpvdmVybGF5Ii8+PC9zdmc+&logoColor=white)](https://code.visualstudio.com/)
[![Build with PlatformIO](https://img.shields.io/badge/build%20with-PlatformIO-orange?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMjUwMCIgaGVpZ2h0PSIyNTAwIiB2aWV3Qm94PSIwIDAgMjU2IDI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCI+PHBhdGggZD0iTTEyOCAwQzkzLjgxIDAgNjEuNjY2IDEzLjMxNCAzNy40OSAzNy40OSAxMy4zMTQgNjEuNjY2IDAgOTMuODEgMCAxMjhjMCAzNC4xOSAxMy4zMTQgNjYuMzM0IDM3LjQ5IDkwLjUxQzYxLjY2NiAyNDIuNjg2IDkzLjgxIDI1NiAxMjggMjU2YzM0LjE5IDAgNjYuMzM0LTEzLjMxNCA5MC41MS0zNy40OUMyNDIuNjg2IDE5NC4zMzQgMjU2IDE2Mi4xOSAyNTYgMTI4YzAtMzQuMTktMTMuMzE0LTY2LjMzNC0zNy40OS05MC41MUMxOTQuMzM0IDEzLjMxNCAxNjIuMTkgMCAxMjggMCIgZmlsbD0iI0ZGN0YwMCIvPjxwYXRoIGQ9Ik0yNDkuMzg2IDEyOGMwIDY3LjA0LTU0LjM0NyAxMjEuMzg2LTEyMS4zODYgMTIxLjM4NkM2MC45NiAyNDkuMzg2IDYuNjEzIDE5NS4wNCA2LjYxMyAxMjggNi42MTMgNjAuOTYgNjAuOTYgNi42MTQgMTI4IDYuNjE0YzY3LjA0IDAgMTIxLjM4NiA1NC4zNDYgMTIxLjM4NiAxMjEuMzg2IiBmaWxsPSIjRkZGIi8+PHBhdGggZD0iTTE2MC44NjkgNzQuMDYybDUuMTQ1LTE4LjUzN2M1LjI2NC0uNDcgOS4zOTItNC44ODYgOS4zOTItMTAuMjczIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzJzLTEwLjMyIDQuNjItMTAuMzIgMTAuMzJjMCAzLjc1NSAyLjAxMyA3LjAzIDUuMDEgOC44MzdsLTUuMDUgMTguMTk1Yy0xNC40MzctMy42Ny0yNi42MjUtMy4zOS0yNi42MjUtMy4zOWwtMi4yNTggMS4wMXYxNDAuODcybDIuMjU4Ljc1M2MxMy42MTQgMCA3My4xNzctNDEuMTMzIDczLjMyMy04NS4yNyAwLTMxLjYyNC0yMS4wMjMtNDUuODI1LTQwLjU1NS01Mi4xOTd6TTE0Ni41MyAxNjQuOGMtMTEuNjE3LTE4LjU1Ny02LjcwNi02MS43NTEgMjMuNjQzLTY3LjkyNSA4LjMyLTEuMzMzIDE4LjUwOSA0LjEzNCAyMS41MSAxNi4yNzkgNy41ODIgMjUuNzY2LTM3LjAxNSA2MS44NDUtNDUuMTUzIDUxLjY0NnptMTguMjE2LTM5Ljc1MmE5LjM5OSA5LjM5OSAwIDAgMC05LjM5OSA5LjM5OSA5LjM5OSA5LjM5OSAwIDAgMCA5LjQgOS4zOTkgOS4zOTkgOS4zOTkgMCAwIDAgOS4zOTgtOS40IDkuMzk5IDkuMzk5IDAgMCAwLTkuMzk5LTkuMzk4em0yLjgxIDguNjcyYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDkgMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OXoiIGZpbGw9IiNFNTcyMDAiLz48cGF0aCBkPSJNMTAxLjM3MSA3Mi43MDlsLTUuMDIzLTE4LjkwMWMyLjg3NC0xLjgzMiA0Ljc4Ni01LjA0IDQuNzg2LTguNzAxIDAtNS43LTQuNjItMTAuMzItMTAuMzItMTAuMzItNS42OTkgMC0xMC4zMTkgNC42Mi0xMC4zMTkgMTAuMzIgMCA1LjY4MiA0LjU5MiAxMC4yODkgMTAuMjY3IDEwLjMxN0w5NS44IDc0LjM3OGMtMTkuNjA5IDYuNTEtNDAuODg1IDIwLjc0Mi00MC44ODUgNTEuODguNDM2IDQ1LjAxIDU5LjU3MiA4NS4yNjcgNzMuMTg2IDg1LjI2N1Y2OC44OTJzLTEyLjI1Mi0uMDYyLTI2LjcyOSAzLjgxN3ptMTAuMzk1IDkyLjA5Yy04LjEzOCAxMC4yLTUyLjczNS0yNS44OC00NS4xNTQtNTEuNjQ1IDMuMDAyLTEyLjE0NSAxMy4xOS0xNy42MTIgMjEuNTExLTE2LjI4IDMwLjM1IDYuMTc1IDM1LjI2IDQ5LjM2OSAyMy42NDMgNjcuOTI2em0tMTguODItMzkuNDZhOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTkgOS4zOTggOS4zOTkgOS4zOTkgMCAwIDAgOS40IDkuNCA5LjM5OSA5LjM5OSAwIDAgMCA5LjM5OC05LjQgOS4zOTkgOS4zOTkgMCAwIDAtOS4zOTktOS4zOTl6bS0yLjgxIDguNjcxYTIuMzc0IDIuMzc0IDAgMSAxIDAtNC43NDggMi4zNzQgMi4zNzQgMCAwIDEgMCA0Ljc0OHoiIGZpbGw9IiNGRjdGMDAiLz48L3N2Zz4=)](https://platformio.org/)
[![PlatformIO Registry](https://badges.registry.platformio.org/packages/k0i05/library/esp_sht4x.svg)](https://registry.platformio.org/libraries/k0i05/esp_sht4x)
[![ESP Component Registry](https://components.espressif.com/components/k0i05/esp_sht4x/badge.svg)](https://components.espressif.com/components/k0i05/esp_sht4x)

## Overview

The `esp_sht4x` component is an ESP-IDF compatible driver for the Sensirion SHT4x series of digital humidity and temperature sensors. It utilizes the I2C bus for communication and provides a high-level API for sensor configuration, measurement, and data conversion.

## Architecture & Dependencies

This driver is built upon the ESP-IDF I2C Master driver (`driver/i2c_master.h`). It handles the low-level I2C transactions, including command transmission, data reception, and CRC verification, abstracting these details from the user.

**Dependencies:**

- `driver/i2c_master.h`: For I2C bus communication.
- `esp_err.h`: For standard error handling.
- `esp_log.h`: For logging.
- `freertos/FreeRTOS.h`, `freertos/task.h`: For delays and task management.
- `math.h`: For dew-point and wet-bulb calculations.

## Data Structures

### Configuration: `sht4x_config_t`

This structure defines the initial state of the SHT4x device.

| Field | Type | Description |
|-------|------|-------------|
| `i2c_address` | `uint16_t` | I2C device address (Default: `0x44` or `0x45`). |
| `i2c_clock_speed` | `uint32_t` | I2C SCL clock frequency (Default: `100000` Hz). |
| `repeat_mode` | `sht4x_repeat_modes_t` | Measurement repeatability (resolution) setting. |
| `heater_mode` | `sht4x_heater_modes_t` | Built-in heater configuration. |

**Default Configuration Macro:** `SHT4X_CONFIG_DEFAULT`

### Enumerations

#### `sht4x_repeat_modes_t`

Controls the duration and precision of measurements.

- `SHT4X_REPEAT_HIGH`: High repeatability (Longest duration).
- `SHT4X_REPEAT_MEDIUM`: Medium repeatability.
- `SHT4X_REPEAT_LOW`: Low repeatability (Shortest duration).

#### `sht4x_heater_modes_t`

Controls the on-chip heater to remove condensation or check for drift.

- `SHT4X_HEATER_OFF`: Heater disabled.
- `SHT4X_HEATER_HIGH_LONG`: High power (~200mW), 1s.
- `SHT4X_HEATER_HIGH_SHORT`: High power (~200mW), 0.1s.
- `SHT4X_HEATER_MEDIUM_LONG`: Medium power (~110mW), 1s.
- `SHT4X_HEATER_MEDIUM_SHORT`: Medium power (~110mW), 0.1s.
- `SHT4X_HEATER_LOW_LONG`: Low power (~20mW), 1s.
- `SHT4X_HEATER_LOW_SHORT`: Low power (~20mW), 0.1s.

### Data Record: `sht4x_data_record_t`

A container for all measurement outputs.

- `drybulb` (float): Dry-Bulb Temperature in 째C.
- `humidity` (float): Relative Humidity in %.
- `dewpoint` (float): Calculated Dew-Point in 째C.
- `wetbulb` (float): Calculated Wet-Bulb temperature in 째C.

## API Reference

### Initialization

- **`sht4x_init`**: Allocates resources, probes the I2C bus, resets the sensor, reads the serial number, and initializes the device handle. Accepts a `void*` master handle.

### Measurement

- **`sht4x_get_measurement`**: Performs a blocking measurement based on current settings and returns Temperature and Humidity.
- **`sht4x_get_measurements`**: Same as above but also calculates and returns Dew-Point and Wet-Bulb.
- **`sht4x_get_measurement_record`**: Returns all data in a `sht4x_data_record_t` struct.

### Configuration

- **`sht4x_set_repeat_mode` / `sht4x_get_repeat_mode`**: Set/Get the repeatability mode.
- **`sht4x_set_heater_mode` / `sht4x_get_heater_mode`**: Set/Get the heater mode.

### System & Maintenance

- **`sht4x_reset`**: Sends a soft-reset command to the sensor.
- **`sht4x_remove`**: Removes the device from the I2C bus (does not free memory).
- **`sht4x_delete`**: Removes the device and frees the handle memory.
- **`sht4x_get_fw_version`**: Returns the driver version string.

## Implementation Details

### I2C Communication

The driver uses standard I2C read/write operations.

- **Commands**: 8-bit commands are sent to trigger measurements or read serial numbers.
- **Response**: Data is received in 16-bit words followed by an 8-bit CRC.

### CRC8 Verification

Every 2 bytes of data received from the SHT4x are followed by a CRC8 checksum. The driver implements the polynomial `0x31` (x^8 + x^5 + x^4 + 1) with initialization `0xFF` to validate data integrity. If the calculated CRC does not match the received CRC, `ESP_ERR_INVALID_CRC` is returned.

### Signal Conversion

Raw ADC values are converted to physical units using the formulas specified in the datasheet:

- **Temperature**: $T = -45 + 175 \cdot \frac{S_T}{2^{16}-1}$
- **Humidity**: $RH = -6 + 125 \cdot \frac{S_{RH}}{2^{16}-1}$

### Derived Calculations

- **Dew Point**: Calculated using the Magnus formula approximation.
- **Wet Bulb**: Calculated using an empirical formula based on dry-bulb temperature and relative humidity (Stull, 2011).

### Timing

The driver handles necessary delays:

- **Power-up**: Waits 5ms.
- **Soft Reset**: Waits 25ms.
- **Measurement**: Waits for a duration corresponding to the selected repeatability or heater mode (e.g., up to ~1.1s for long heater pulses).

## Hardware Abstraction Layer (HAL)

The driver implements a Hardware Abstraction Layer (HAL) to isolate the core driver logic from the specific ESP-IDF I2C driver implementation. This is achieved through a set of `static inline` functions prefixed with `hal_`.

### HAL Implementation Strategy

- **Encapsulation**: All direct calls to `i2c_master_*` functions are contained within `hal_*` functions.
- **Error Propagation**: HAL functions return `esp_err_t` to propagate low-level I2C errors up to the public API.
- **Device Handle**: The `sht4x_device_t` structure holds a `void*` handle (abstracting the underlying `i2c_master_dev_handle_t`), which is passed to HAL functions to identify the target device.

### HAL Functions

- **`hal_probe`**: Checks if the device exists on the I2C bus using `i2c_master_probe`. Accepts a `void*` master handle.
- **`hal_init`**: Configures the I2C device (address, clock speed) and adds it to the master bus using `i2c_master_bus_add_device`. Accepts a `void*` master handle.
- **`hal_read`**: Wraps `i2c_master_receive` to read data from the sensor. Accepts a `void*` device handle.
- **`hal_write`**: Wraps `i2c_master_transmit` to write data (commands) to the sensor. Accepts a `void*` device handle.
- **`hal_write_command`**: A specialized write function for sending single-byte commands. Accepts a `void*` device handle.
- **`hal_remove`**: Removes the device from the I2C bus using `i2c_master_bus_rm_device`. Accepts a `void*` device handle.
- **`hal_get_serial_number_register`**: Executes the specific sequence (write command -> delay -> read) to retrieve the serial number.
- **`hal_set_reset_register`**: Sends the soft-reset command and waits for the required reset time.
- **`hal_get_adc_signals`**: Handles the measurement sequence: sends command, waits for measurement duration, and reads raw ADC results. It includes retry logic for the read operation.

## Internal Helper Functions

These `static inline` functions perform utility tasks, calculations, and logic mapping to support the public API and HAL.

### CRC Calculation

- **`calculate_crc8`**: Implements the CRC-8 algorithm (Polynomial: `0x31`, Init: `0xFF`) to verify data integrity of received packets.

### Timing & Command Mapping

- **`get_heater_duration`**: Returns the required measurement duration (in ms) based on the selected heater mode.
- **`get_repeat_duration`**: Returns the required measurement duration (in ms) based on the selected repeatability mode (when heater is off).
- **`get_measurement_duration`**: Determines the total wait time required for a measurement, considering both heater and repeatability settings.
- **`get_measurement_tick_duration`**: Converts the measurement duration from milliseconds to FreeRTOS ticks.
- **`map_heater_command`**: Maps a `sht4x_heater_modes_t` enum value to the corresponding I2C command byte.
- **`get_command`**: Determines the correct I2C command byte to send based on the current heater and repeatability configuration.

### Range Validation

- **`is_value_in_range`**: Generic helper to check if a float value is within a min/max range.
- **`is_drybulb_in_range`**: Validates if a temperature value is within the sensor's operating range (-40 to 125 째C).
- **`is_humidity_in_range`**: Validates if a humidity value is within the sensor's operating range (0 to 100 %).

### Helper: Derived Calculations

- **`get_dewpoint`**: Calculates dew point temperature using the Magnus formula. Includes input validation.
- **`get_wetbulb`**: Calculates wet bulb temperature using the Stull formula. Includes input validation.

### Helper: Signal Conversion

- **`convert_adc_signal_to_temperature`**: Converts the raw 16-bit ADC temperature value to degrees Celsius.
- **`convert_adc_signal_to_humidity`**: Converts the raw 16-bit ADC humidity value to relative humidity percentage.

Copyright (c) 2025 Eric Gionet (<gionet.c.eric@gmail.com>)
